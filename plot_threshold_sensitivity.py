
import matplotlib
import numpy as np
import os
import subprocess

matplotlib.use('Agg')
import matplotlib.pyplot as plt
import pylab

out_folder = './results/p_value_plots'
if not os.path.exists(out_folder):
    os.makedirs(out_folder)

point_list = []
no_prosnet = 0

for sim_thresh in np.arange(0.01, 0.51, 0.01):
# for sim_thresh in np.arange(0.01, 0.02, 0.01):
    command = 'python build_patient_feature_matrix.py 50 %g' % sim_thresh
    print command
    subprocess.call(command, shell=True)
    command = 'python subcategorize_patients.py full 50 > %s/%g.txt' % (
        out_folder, sim_thresh)
    subprocess.call(command, shell=True)

    f = open('%s/%g.txt' % (out_folder, sim_thresh))
    f.readline() # Skip the filename.
    p_val = float(f.readline().split()[1])
    point_list += [(sim_thresh, p_val)]
    # Read the second line if it's the first time doing so.
    if no_prosnet == 0:
        f.readline() # Skip the filename.
        no_prosnet = float(f.readline().split()[1])
    f.close()

plt.title('Survival plot p-value vs. cosine similarity lower bound')
plt.xlabel('Cosine Similarity Lower Bound')
plt.ylabel('p-value of Survival Plot')
plt.plot(*zip(*point_list))
# TODO: This is the best p-value of the survival curve generated by no-prosnet.
plt.axhline(no_prosnet, color='r')
plt.ylim(0, 0.05)
plt.xlim(0, 0.5)
plt.show()

pylab.savefig('%s/p_val_plot.png' % out_folder)
plt.close()